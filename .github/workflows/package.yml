# build-and-test.yml - Modern release workflow
name: Build and Test DKMS Package

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*'
  pull_request:
    branches:
      - main

jobs:
  package:
    strategy:
      matrix:
        format:
          - deb
          - rpm
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    - uses: kentik/pkg@v1.0.0-rc8
      with:
        name: dasharo-acpi-dkms
        version: 0.9.1
        arch: x86_64
        format: ${{ matrix.format }}
        package: packaging/package.yaml
    - uses: actions/upload-artifact@v4
      with:
        path: "*.${{ matrix.format }}"
        name: dasharo-acpi-dkms.${{ matrix.format }}

  test-deb:
    needs: package
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Download built .deb package
      uses: actions/download-artifact@v4
      with:
        name: dasharo-acpi-dkms.deb
    
    - name: Install DKMS dependencies
      run: |
        sudo apt update
        sudo apt install -y dkms linux-headers-$(uname -r) build-essential
    
    - name: Install and test DKMS package
      run: |
        sudo apt install -y ./dasharo-acpi-dkms*.deb
        sudo dkms status
        ls -la /usr/src/dasharo-acpi-*/

 # Create release using modern GitHub CLI
  release:
    needs: [package, test-deb]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    permissions:
      contents: write  # Required for creating releases

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        # Remove 'v' prefix from tag (v0.9.1 -> 0.9.1)
        VERSION=${GITHUB_REF_NAME#v}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"

    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: Rename packages to match release naming pattern
      run: |
        # Artifacts are downloaded into directories, so we need to move files out
        mv dasharo-acpi-dkms.deb/*.deb dasharo-acpi-dkms_${{ steps.version.outputs.version }}_amd64.deb
        mv dasharo-acpi-dkms.rpm/*.rpm dasharo-acpi-dkms-${{ steps.version.outputs.version }}.x86_64.rpm
        # Verify final files
        ls -la *.deb *.rpm

    - name: Create release with packages
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        gh release create ${{ github.ref_name }} \
          --title "Dasharo ACPI DKMS ${{ github.ref_name }}" \
          dasharo-acpi-dkms_${{ steps.version.outputs.version }}_amd64.deb \
          dasharo-acpi-dkms-${{ steps.version.outputs.version }}.x86_64.rpm
